%===================================
% KEY SUMMARY â€” Tutorial 10 Concepts
%===================================

\section*{Key Concepts and Common Pitfalls (Tutorial 10 Summary)}

\subsection*{1. Simulink vs.\ MATLAB ODE Solvers}

Simulink provides a block-diagram environment for simulating dynamic systems. The same problems can be solved programmatically in MATLAB using \texttt{ode45}. Key equivalences:

\begin{itemize}
    \item \textbf{Integrator block} $\Leftrightarrow$ state variable (integrate $\dot{x}$ to get $x$)
    \item \textbf{Gain block} $\Leftrightarrow$ scalar multiplication in the ODE function
    \item \textbf{Sum block} $\Leftrightarrow$ addition inside the ODE function
    \item \textbf{Fcn/Math block} $\Leftrightarrow$ nonlinear expression (e.g., \texttt{sin(x)}, \texttt{x\^{}3})
\end{itemize}

\subsection*{2. Converting to State-Variable Form}

Every $n$th-order ODE must be reduced to $n$ first-order equations before using \texttt{ode45}:
\begin{enumerate}
    \item Solve for the highest derivative.
    \item Let $x_1 = y,\; x_2 = \dot{y},\; \ldots,\; x_n = y^{(n-1)}$.
    \item Write $\dot{x}_1 = x_2,\; \dot{x}_2 = x_3,\; \ldots,\; \dot{x}_n = (\text{expression from step 1})$.
\end{enumerate}

\subsection*{3. Transfer Function Approach (Linear Systems)}

For linear systems with zero initial conditions, use the Control System Toolbox:
\begin{itemize}
    \item \texttt{tf(num, den)}: create a transfer function from coefficient vectors
    \item \texttt{lsim(sys, u, t)}: simulate response to an arbitrary input vector
    \item \texttt{series(sys1, sys2)}: cascade two transfer functions
\end{itemize}

\subsection*{4. Nonlinear Systems}

Nonlinear elements (e.g., $\sin x$, $x^3$, saturation) require \texttt{ode45} because the Control System Toolbox only supports LTI systems. Use \texttt{min}/\texttt{max} to implement Saturation blocks.

\vspace{1cm}
\hrule
\vspace{0.5cm}

\section*{Tutorial Problems}

%-----------------------------------
\myproblem{Problem 3}
Draw a simulation diagram for the equation:
\[3\dot{y} + 5\sin y = f(t)\]

\begin{figure}[h!]
    \centering
    \begin{tikzpicture}[>=Stealth, node distance=1cm and 1.2cm]
        \tikzset{
            oval/.style = {draw, rounded corners=2ex, minimum width=1.2cm, minimum height=0.6cm, align=center},
            block/.style = {draw, rectangle, minimum height=1.2cm, minimum width=1.2cm, align=center},
            sum/.style = {draw, circle, minimum size=0.8cm, inner sep=0pt},
            % Points RIGHT (forward path)
            gain/.style = {draw, isosceles triangle, isosceles triangle apex angle=60,
                           minimum height=1cm, minimum width=1cm,
                           shape border rotate=0, inner sep=2pt},
            % Points LEFT (feedback path)
            gainleft/.style = {draw, isosceles triangle, isosceles triangle apex angle=60,
                                minimum height=1cm, minimum width=1cm,
                                shape border rotate=180, inner sep=2pt}
        }
        % Input Block
        \node [oval, label=below:{$f(t)$}] (input) {1};
        % Summing Junction
        \node [sum, right=1.2cm of input] (sum) {};
        \node at ($(sum.west)+(0.18,0.12)$) {\tiny $+$};
        \node at ($(sum.south)+(0.12,0.18)$) {\tiny $-$};
        % Forward Path Blocks
        \node [gain, right=0.8cm of sum] (gain1) {$\frac{1}{3}$};
        \node [block, right=0.8cm of gain1] (int1) {\Large $\frac{1}{s}$};
        \node [block, right=0.8cm of int1] (int2) {\Large $\frac{1}{s}$};
        % Output Block
        \node [oval, label=below:{$y(t)$}, right=1.5cm of int2] (output) {1};
        % Feedback Path Blocks
        \node [block, below=1.5cm of int2] (sin) {sin};
        \node [gainleft, left=1cm of sin] (gain2) {5};
        % Forward Connections
        \draw [->] (input) -- (sum);
        \draw [->] (sum) -- (gain1);
        \draw [->] (gain1) -- (int1);
        \draw [->] (int1) -- (int2);
        % Tap junction and output connection
        \coordinate (tap) at ($(int2.east)!0.4!(output.west)$);
        \draw [->] (int2) -- (output);
        % Feedback Connections
        \draw [->] (tap) |- (sin);
        \draw [->] (sin) -- (gain2);
        \draw [->] (gain2) -| (sum.south);
        % Draw the tap dot
        \filldraw (tap) circle (1.5pt);
    \end{tikzpicture}
    \caption{Simulink Block Diagram}
\end{figure}

%-----------------------------------
\myproblem{Problem 5}
Draw a simulation diagram for the model:
\begin{align*}
\dot{x} &= -3x + 2y + f(t), \\
\dot{y} &= 4x - 5y
\end{align*}

\begin{figure}[H]
    \centering
    \begin{tikzpicture}[>=Stealth, node distance=1cm and 1.2cm]
        \tikzset{
            oval/.style     = {draw, rounded corners=2ex, minimum width=1.2cm, minimum height=0.6cm, align=center},
            block/.style    = {draw, rectangle, minimum height=1.0cm, minimum width=1.0cm, align=center},
            sum/.style      = {draw, circle, minimum size=0.8cm, inner sep=0pt},
            gainR/.style    = {draw, isosceles triangle, isosceles triangle apex angle=60,
                               minimum height=0.9cm, shape border rotate=0, inner sep=2pt},
            gainL/.style    = {draw, isosceles triangle, isosceles triangle apex angle=60,
                               minimum height=0.9cm, shape border rotate=180, inner sep=2pt},
        }

        %--- Forward path nodes ---
        \node [oval, label=below:{$f(t)$}] (input) {1};
        \node [sum,  right=1.0cm of input]  (sum1)  {};
        \node [block, right=1.0cm of sum1, label=below:{$x$}] (int1) {$\dfrac{1}{s}$};
        \node [gainR, right=1.0cm of int1] (gain4) {4};
        \node [sum,  right=0.9cm of gain4] (sum2)  {};
        \node [block, right=1.0cm of sum2] (int2)  {$\dfrac{1}{s}$};
        \node [oval, label=below:{$y$}, right=1.0cm of int2] (output) {1};

        %--- Sum labels ---
        \node at ($(sum1.north)+(0.12,-0.20)$) {\tiny $+$};  % top
        \node at ($(sum1.west)+(0.18, -0.05)$)  {\tiny $+$};   % left side
        \node at ($(sum1.south)+(0.12,0.18)$) {\tiny $-$};   % bottom
        \node at ($(sum2.west)+(0.18,0.12)$)  {\tiny $+$};   % left side
        \node at ($(sum2.south)+(-0.05, 0.18)$) {\tiny $-$};   % bottom

        %--- Feedback gain nodes ---
        \node [gainL, above=1.2cm of gain4] (gain2) {2};
        \node [gainL, below=1.2cm of int1]  (gain3) {3};
        \node [gainL, below=1.2cm of int2]  (gain5) {5};

        %--- Tap coordinates ---
        \coordinate (tap1) at ($(int1.east)!0.5!(gain4.west)$);
        \coordinate (tap2) at ($(int2.east)!0.5!(output.west)$);

        %--- Forward connections ---
        \draw [->] (input) -- (sum1);
        \draw [->] (sum1)  -- (int1);
        \draw [->] (int1)  -- (gain4);
        \draw [->] (gain4) -- (sum2);
        \draw [->] (sum2)  -- (int2);
        \draw [->] (int2)  -- (output);

        %--- Tap dots ---
        \filldraw (tap1) circle (1.5pt);
        \filldraw (tap2) circle (1.5pt);

        %--- Upper feedback: tap2 -> gain2 -> sum1.north ---
        \draw [->] (tap2) |- (gain2.east);
        \draw [->] (gain2.west) -| (sum1.north);

        %--- Lower-left feedback: tap1 -> gain3 -> sum1.south ---
        \draw [->] (tap1) |- (gain3.east);
        \draw [->] (gain3.west) -| (sum1.south);

        %--- Lower-right feedback: tap2 -> gain5 -> sum2.south ---
        \draw [->] (tap2) |- (gain5.east);
        \draw [->] (gain5.west) -| (sum2.south);

    \end{tikzpicture}
    \caption{Simulink Block Diagram}
\end{figure}


%-----------------------------------
\myproblem{Problem 8}
Create a Simulink model to plot the solution for $0 \le t \le 6$:
\[10\ddot{y} = 7\sin 4t + 5\cos 3t, \qquad y(0)=3,\;\dot{y}(0)=2\]

\begin{figure}[h!]
    \centering
    \begin{tikzpicture}[>=Stealth, node distance=1cm and 1.2cm]
        \tikzset{
            waveblock/.style = {draw, rectangle, minimum height=1.0cm, minimum width=1.0cm, align=center},
            block/.style     = {draw, rectangle, minimum height=1.0cm, minimum width=1.0cm, align=center},
            outblock/.style  = {draw, rectangle, minimum height=0.8cm, minimum width=1.2cm, align=center},
            sum/.style       = {draw, circle, minimum size=0.8cm, inner sep=0pt},
            gainR/.style     = {draw, isosceles triangle, isosceles triangle apex angle=60,
                                minimum height=1.0cm, shape border rotate=0, inner sep=2pt},
        }

        % Wave source blocks
        \node [waveblock, label=below:{\small Sine Wave\newline Function}] (sine) {$\sim$};
        \node [waveblock, below=1.2cm of sine, label=below:{\small Cosine Wave\newline Function}] (cosine) {$\sim$};

        % Summing junction (vertically centered between sine and cosine)
        \node [sum, right=1.0cm of sine, yshift=-0.7cm] (sum1) {};
        \node at ($(sum1.north)+(0.12,-0.18)$) {\tiny $+$};
        \node at ($(sum1.south)+(0.12, 0.18)$) {\tiny $+$};

        % Forward path
        \node [gainR, right=0.8cm of sum1] (gain) {$\frac{1}{10}$};
        \node [block,  right=1.0cm of gain, label=below:{\small Integrator}]   (int1) {$\dfrac{1}{s}$};
        \node [block,  right=1.0cm of int1, label=below:{\small Integrator 1}] (int2) {$\dfrac{1}{s}$};
        \node [outblock, right=1.0cm of int2, label=below:{\small To Workspace}] (out) {\small simout};

        % Connections: sine -> sum (from top)
        \draw [->] (sine.east) -- ++(0.3,0) |- (sum1.north);

        % Connections: cosine -> sum (from bottom)
        \draw [->] (cosine.east) -- ++(0.3,0) |- (sum1.south);

        % Forward path connections
        \draw [->] (sum1)  -- (gain);
        \draw [->] (gain)  -- (int1);
        \draw [->] (int1)  -- (int2);
        \draw [->] (int2)  -- (out);

    \end{tikzpicture}
    \caption{Simulink Block Diagram}
\end{figure}

%-----------------------------------
\myproblem{Problem 10}
The equation $\dot{x} + x = \tan t$, $x(0) = 0$ has no analytical solution. The approximate solution (less accurate for large $t$) is:
\[x(t) = \tfrac{1}{3}t^3 - t^2 + 3t - 3 + 3\,e^{-t}\]
Compare the numerical and approximate solutions.



%-----------------------------------
\myproblem{Problem 13}
Construct a Simulink model to plot solutions for $0 \le t \le 2$:
\begin{align*}
\dot{x}_1 &= -6x_1 + 4x_2, \\
\dot{x}_2 &= 5x_1 - 7x_2 + f(t)
\end{align*}
where $f(t) = 3t$. Use the Ramp block in the Sources library.

\begin{lstlisting}
% State: s(1) = x1, s(2) = x2
% f(t) = 3t (ramp with slope 3)
f = @(t) 3*t;
ode = @(t, s) [-6*s(1) + 4*s(2);
                5*s(1) - 7*s(2) + f(t)];
[t, sol] = ode45(ode, [0, 2], [0; 0]);

plot(t, sol(:,1), '-', t, sol(:,2), '--', 'LineWidth', 1.5);
legend('x_1(t)', 'x_2(t)');
title('State Response with Ramp Input f(t) = 3t');
xlabel('t'); grid on;
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 15}
Construct a Simulink model to plot solutions for $0 \le t \le 10$:
\[\dot{x} = -5x + 3y + 5\sin 2t,\quad x(0)=0\]
\[\dot{y} = 3x - 4y,\quad y(0)=0\]

\begin{lstlisting}
% State: s(1) = x, s(2) = y
ode = @(t, s) [-5*s(1) + 3*s(2) + 5*sin(2*t);
                3*s(1) - 4*s(2)];
[t, sol] = ode45(ode, [0, 10], [0; 0]);

plot(t, sol(:,1), '-', t, sol(:,2), '--', 'LineWidth', 1.5);
legend('x(t)', 'y(t)');
title('State Response with Sinusoidal Forcing');
xlabel('t'); grid on;
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 18}
Construct a Simulink model for $5\dot{x} + \sin x = f(t)$, $x(0) = 0$, where $g(t) = 10\sin 4t$ and:
\[f(t) = \begin{cases} -5 & \text{if } g(t) \le -5 \\ g(t) & \text{if } -5 < g(t) < 5 \\ 5 & \text{if } g(t) \ge 5 \end{cases}\]

\begin{lstlisting}
% Saturation: clip g(t) to [-5, 5]
g = @(t) 10 * sin(4*t);
f = @(t) min(5, max(-5, g(t)));

% ODE: x_dot = (f(t) - sin(x)) / 5
ode = @(t, x) (f(t) - sin(x)) / 5;
[t, x] = ode45(ode, [0, 5], 0);

figure;
subplot(2,1,1);
plot(t, f(t)); title('Forcing f(t) [Saturated]');
xlabel('t'); ylabel('f(t)'); grid on;
subplot(2,1,2);
plot(t, x); title('Response x(t)');
xlabel('t'); ylabel('x(t)'); grid on;
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 25}
Use Transfer Function blocks to plot solutions for $0 \le t \le 2$:
\[3\ddot{x} + 15\dot{x} + 18x = f(t),\quad x(0)=\dot{x}(0)=0\]
\[2\ddot{y} + 16\dot{y} + 50y = x(t),\quad y(0)=\dot{y}(0)=0\]
where $f(t) = 75\,u_s(t)$.

\begin{lstlisting}
% X(s)/F(s) = 1 / (3s^2 + 15s + 18)
% Y(s)/X(s) = 1 / (2s^2 + 16s + 50)
sys_x = tf(1, [3, 15, 18]);
sys_y = tf(1, [2, 16, 50]);

% Step input: f(t) = 75 * us(t)
t = 0:0.005:2;
f_input = 75 * ones(size(t));

x_out = lsim(sys_x, f_input, t);
y_out = lsim(series(sys_x, sys_y), f_input, t);

figure;
subplot(2,1,1);
plot(t, x_out, 'LineWidth', 1.5);
title('x(t)'); xlabel('t'); grid on;
subplot(2,1,2);
plot(t, y_out, 'LineWidth', 1.5);
title('y(t)'); xlabel('t'); grid on;
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 28}
Create a Simulink model to plot the solution for $0 \le t \le 1$:
\[\frac{Y(s)}{F(s)} = \frac{4}{s+5}, \qquad f(t) = u_s(t) - u_s(t-1)\]

\begin{lstlisting}
sys = tf(4, [1, 5]);

% Pulse input: f(t) = us(t) - us(t-1)
% Over [0,1]: f(t) = 1 for t < 1, drops to 0 at t = 1
t = 0:0.001:1;
f_input = double(t < 1);

y_out = lsim(sys, f_input, t);

plot(t, y_out, 'b-', t, f_input, 'r--', 'LineWidth', 1.5);
legend('y(t)', 'f(t)');
title('Response: Y(s)/F(s) = 4/(s+5), Pulse Input');
xlabel('t'); grid on;
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 33}
Create a Simulink model for a mass supported by a nonlinear hardening spring, $0 \le t \le 2$:
\[5\ddot{y} = 5g - (900y + 1700y^3), \qquad y(0)=0.5,\;\dot{y}(0)=0\]
Use $g = 9.81$ m/s$^2$.

\begin{lstlisting}
% State: x(1) = y, x(2) = y_dot
% y_ddot = g - (900*y + 1700*y^3) / 5
g = 9.81;
ode = @(t, x) [x(2);
               g - (900*x(1) + 1700*x(1)^3) / 5];
[t, x] = ode45(ode, [0, 2], [0.5; 0]);

plot(t, x(:,1), 'LineWidth', 1.5);
title('Nonlinear Hardening Spring Response');
xlabel('t (s)'); ylabel('y (m)');
grid on;
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 35}
The equation for water height $h$ in a spherical tank (radius $r = 3$ m) with drain (radius 2 cm, $C_d = 0.5$), $h(0) = 5$ m:
\[\pi(2rh - h^2)\frac{dh}{dt} = -C_d A\sqrt{2gh}\]
Use Simulink to solve the nonlinear equation and plot $h(t)$ until $h(t) = 0$.

\begin{lstlisting}
r = 3; Cd = 0.5; g = 9.81;
A = pi * 0.02^2;  % drain area, radius = 0.02 m

% ODE: dh/dt = -Cd*A*sqrt(2gh) / (pi*(2r*h - h^2))
dhdt = @(t, h) -Cd * A * sqrt(2*g*h) / (pi * (2*r*h - h^2));

opts = odeset('Events', @stop_event, 'RelTol', 1e-6);
[t, h] = ode45(dhdt, [0, 80000], 5, opts);

plot(t/3600, h, 'LineWidth', 1.5);
title('Spherical Tank Draining');
xlabel('Time (hours)'); ylabel('Water Height h (m)');
grid on;
fprintf('Tank empties at t = %.2f hours\n', t(end)/3600);

function [value, isterminal, direction] = stop_event(~, h)
    value = h - 0.001;   % Stop when h < 1 mm
    isterminal = 1;
    direction = -1;
end
\end{lstlisting}

%-----------------------------------
\myproblem{Problem 45}
Consider the system in Figure P45 with $m_1=m_2=1$, $c_1=3$, $c_2=1$, $k_1=1$, $k_2=4$:
\[m_1\ddot{x}_1 + (c_1+c_2)\dot{x}_1 + (k_1+k_2)x_1 - c_2\dot{x}_2 - k_2x_2 = 0\]
\[m_2\ddot{x}_2 + c_2\dot{x}_2 + k_2x_2 - c_2\dot{x}_1 - k_2x_1 = f(t)\]
\begin{itemize}
    \item[a.] Develop a Simulink model using state-variable representation.
    \item[b.] Plot $x_1(t)$ for zero initial conditions with piecewise input:
    \[f(t) = \begin{cases} t & 0 \le t \le 1 \\ 2-t & 1 < t < 2 \\ 0 & t \ge 2 \end{cases}\]
\end{itemize}

\begin{lstlisting}
% Parameters
m1=1; m2=1; c1=3; c2=1; k1=1; k2=4;

% Piecewise input (triangular pulse)
f = @(t) (t >= 0 & t <= 1).*t + (t > 1 & t < 2).*(2 - t);

% State: s = [x1; x1_dot; x2; x2_dot]
% x1_ddot = [-(c1+c2)*x1_dot - (k1+k2)*x1 + c2*x2_dot + k2*x2] / m1
% x2_ddot = [f(t) + c2*x1_dot + k2*x1 - c2*x2_dot - k2*x2] / m2
ode = @(t, s) [
    s(2);
    (-(c1+c2)*s(2) - (k1+k2)*s(1) + c2*s(4) + k2*s(3)) / m1;
    s(4);
    (f(t) + c2*s(2) + k2*s(1) - c2*s(4) - k2*s(3)) / m2
];

[t, sol] = ode45(ode, [0, 10], zeros(4, 1));

plot(t, sol(:,1), 'LineWidth', 1.5);
title('x_1(t) - Two Mass-Spring-Damper System');
xlabel('t (s)'); ylabel('x_1 (m)');
grid on;
\end{lstlisting}
